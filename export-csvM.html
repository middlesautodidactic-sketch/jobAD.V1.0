<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Export CSV - ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô (‡∏´‡∏•‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô)</title>
  <style>
    body { font-family: sans-serif; padding: 18px; background:#fff; color:#111; }
    h1 { color:#c00; text-align:left; }
    .controls { display:flex; gap:12px; align-items:center; flex-wrap:wrap; margin-bottom:16px; }
    label { font-weight:600; margin-right:8px; }
    input[type="month"] { padding:6px 8px; border:1px solid #ccc; border-radius:6px; }
    button { background:#c00; color:#fff; border:none; padding:8px 12px; border-radius:8px; cursor:pointer; font-weight:700; }
    button:disabled { opacity:0.6; cursor:not-allowed; }
    table { width:100%; border-collapse:collapse; margin-top:14px; }
    th, td { padding:8px 10px; border:1px solid #e5e5e5; text-align:left; }
    th { background:#f8f8f8; }
    .small { font-size:13px; color:#555; }
    #message { margin-top:12px; color:#555; }
    .manager-btn{
      display:inline-block; margin-bottom:15px; margin-right:10px;
      background:#c00; color:#fff; padding:8px 16px;
      border-radius:8px; text-decoration:none; font-weight:bold;
      box-shadow:0 3px 6px rgba(0,0,0,0.15); transition:0.3s;
    }
    .manager-btn:hover{ background:#a00; }
  </style>
</head>
<body>
  <div>
    <a href="manager.html" class="manager-btn">Back to Manager</a>
  </div>
  <h1>üì• Export CSV ‚Äî ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô (‡∏´‡∏•‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô)</h1>

  <div class="controls">
    <div>
      <label for="startMonth">‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏î‡∏∑‡∏≠‡∏ô:</label>
      <input id="startMonth" type="month" />
    </div>
    <div>
      <label for="endMonth">‡∏ñ‡∏∂‡∏á‡πÄ‡∏î‡∏∑‡∏≠‡∏ô:</label>
      <input id="endMonth" type="month" />
    </div>
    <div>
      <label for="includeZero" class="small">‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏î‡πâ‡∏ß‡∏¢</label>
      <input id="includeZero" type="checkbox" checked />
    </div>
    <div>
      <button id="loadBtn">‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
    </div>
    <div>
      <button id="exportBtn" disabled>‚¨áÔ∏è ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î CSV</button>
    </div>
  </div>

  <div id="message" class="small">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏î‡∏∑‡∏≠‡∏ô ‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î "‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•"</div>
  <div id="tableWrap"></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
import { getFirestore, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";

// Firebase Config
const firebaseConfig = {
  apiKey: "AIzaSyAXayBBLVSohNCIsnlWRq6rD0BUbW70MGk",
  authDomain: "events-666d6.firebaseapp.com",
  projectId: "events-666d6",
  storageBucket: "events-666d6.appspot.com",
  messagingSenderId: "589078390914",
  appId: "1:589078390914:web:480ce96137ffac835aac9b",
  measurementId: "G-97GD75S814"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);


    const startMonth = document.getElementById("startMonth");
    const endMonth = document.getElementById("endMonth");
    const includeZeroCheckbox = document.getElementById("includeZero");
    const loadBtn = document.getElementById("loadBtn");
    const exportBtn = document.getElementById("exportBtn");
    const tableWrap = document.getElementById("tableWrap");
    const message = document.getElementById("message");

    let currentReport = [];

    function parseYMD(ymd){
      if(!ymd) return null;
      const parts = ymd.split("-");
      if(parts.length < 3) return null;
      return new Date(parseInt(parts[0]), parseInt(parts[1]) - 1, parseInt(parts[2]));
    }

    function getMonthRange(startStr, endStr){
      const [sy, sm] = startStr.split("-").map(Number);
      const [ey, em] = endStr.split("-").map(Number);
      const start = new Date(sy, sm - 1, 1);
      const end = new Date(ey, em, 1);
      return { start, end };
    }

    loadBtn.addEventListener("click", async ()=>{
      const sVal = startMonth.value;
      const eVal = endMonth.value;
      if(!sVal || !eVal){ alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö"); return; }

      const { start, end } = getMonthRange(sVal, eVal);
      if(start >= end){ alert("‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á"); return; }

      loadBtn.disabled = true;
      exportBtn.disabled = true;
      tableWrap.innerHTML = "";
      message.textContent = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...";

      try{
        const eventsSnap = await getDocs(collection(db,"events"));
        const events = [];
        eventsSnap.forEach(s => {
          const d = s.data();
          d._id = s.id;
          events.push(d);
        });

        const workersSnap = await getDocs(collection(db,"workers"));
        const workers = [];
        workersSnap.forEach(s => {
          const name = s.data().name;
          if(name) workers.push(name);
        });

        // üîπ ‡∏î‡∏∂‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏à‡∏≤‡∏Å events
        const allStatuses = new Set(["‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢", "‡πÑ‡∏°‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢"]);
        events.forEach(ev => {
          if(ev.status && ev.status.trim() !== "") {
            allStatuses.add(ev.status.trim());
          }
        });

        const statusList = Array.from(allStatuses).sort((a,b) => {
          if(a==="‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢") return -1;
          if(b==="‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢") return 1;
          if(a==="‡πÑ‡∏°‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢") return -1;
          if(b==="‡πÑ‡∏°‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢") return 1;
          return a.localeCompare(b,"th");
        });

        const stats = new Map();
        const ensureWorker = name => {
          if(!name) return;
          if(!stats.has(name)) {
            const workerStat = { name, total: 0 };
            statusList.forEach(status => { workerStat[status] = 0; });
            stats.set(name, workerStat);
          }
        };

        // ‚ûï ‡∏ô‡∏±‡∏ö "‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î" ‡πÅ‡∏•‡∏∞‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Ç‡∏≠‡∏á‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏á‡∏≤‡∏ô
        let totalEventsCount = 0;
        const totalStatusCount = {};
        statusList.forEach(status => { totalStatusCount[status] = 0; });

        if(includeZeroCheckbox.checked){
          workers.forEach(w => ensureWorker(w));
        }

        for(const ev of events){
          const startDate = parseYMD(ev.start);
          if(!startDate) continue;
          if(startDate >= start && startDate < end){

            // ‡∏ô‡∏±‡∏ö‡∏á‡∏≤‡∏ô 1 ‡∏ä‡∏¥‡πâ‡∏ô
            totalEventsCount++;

            const workerList = Array.isArray(ev.workers) ? ev.workers : (ev.workers ? [ev.workers] : []);
            
            const status = ev.status ? ev.status.trim() : "";

            // ‚úÖ ‡∏ô‡∏±‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Ç‡∏≠‡∏á‡∏á‡∏≤‡∏ô‡∏ô‡∏µ‡πâ‡πÅ‡∏Ñ‡πà‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß (‡πÑ‡∏°‡πà‡∏ã‡πâ‡∏≥‡∏ï‡∏≤‡∏°‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏ô)
            if(status && statusList.includes(status)) {
              totalStatusCount[status]++;
            }

            for(const w of workerList){
              ensureWorker(w);
              const rec = stats.get(w);
              rec.total++;
              if(status && statusList.includes(status)) {
                rec[status]++;
              }
            }
          }
        }

        const rows = Array.from(stats.values()).sort((a,b)=> a.name.localeCompare(b.name,"th"));
        if(rows.length === 0){
          tableWrap.innerHTML = `<div class="small">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</div>`;
          message.textContent = "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å";
          return;
        }

        // ‡∏£‡∏ß‡∏°‡∏ú‡∏•‡∏£‡∏ß‡∏°‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô
        const totalSum = { total: totalEventsCount }; // ‚úÖ ‡∏ô‡∏±‡∏ö‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏á‡∏≤‡∏ô ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏ô‡∏±‡∏ö‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á
        statusList.forEach(status => { 
          totalSum[status] = totalStatusCount[status]; // ‚úÖ ‡πÉ‡∏ä‡πâ‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏ô‡∏±‡∏ö‡∏à‡∏≤‡∏Å‡∏á‡∏≤‡∏ô‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á
        });

        // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á HTML
        // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á HTML
        let html = `<div style="font-size:16px;margin-bottom:10px;">
                      üî¢ <b>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å: ${totalEventsCount} ‡∏á‡∏≤‡∏ô</b>
                    </div>`;

        html += `<table><thead><tr>
          <th>‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô</th>
          <th>‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</th>
          <th>‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢</th>
          <th>‡πÑ‡∏°‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢</th>
          <th>‡∏£‡∏ß‡∏°</th>
        </tr></thead><tbody>`;

        rows.forEach(r=>{
          const otherTotal = r.total - (r["‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢"] || 0) - (r["‡πÑ‡∏°‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢"] || 0);
          html += `<tr>
            <td>${r.name}</td>
            <td>${r.total}</td>
            <td>${r["‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢"] || 0}</td>
            <td>${r["‡πÑ‡∏°‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢"] || 0}</td>
            <td>${otherTotal}</td>
          </tr>`;
        });

        html += `</tbody></table>`;

        // ‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡∏£‡∏≤‡∏¢‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•
        html += `<h3 style="margin-top:30px;color:#c00;">üìä ‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡∏£‡∏ß‡∏°‡∏£‡∏≤‡∏¢‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•</h3>`;
        html += `<ul>`;
        rows.forEach(r=>{
          let details = statusList.map(s => `${s} ${r[s]}`).join(", ");
          html += `<li><b>${r.name}</b>: ‡∏£‡∏ß‡∏° ${r.total} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á (${details})</li>`;
        });
        html += `</ul>`;

        tableWrap.innerHTML = html;
        message.textContent = `‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡∏£‡∏ß‡∏°‡∏ä‡πà‡∏ß‡∏á ${sVal} ‡∏ñ‡∏∂‡∏á ${eVal}`;

        exportBtn.disabled = false;
        currentReport = { rows, totalSum, totalEventsCount, sVal, eVal, statusList };

      }catch(err){
        console.error(err);
        alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•");
      }finally{
        loadBtn.disabled = false;
      }
    });

    // Export CSV
    exportBtn.addEventListener("click", ()=>{
      if(!currentReport?.rows?.length) return alert("‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ export");

      const { rows, totalSum, totalEventsCount, sVal, eVal, statusList } = currentReport;

      const header = ["‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏î‡∏∑‡∏≠‡∏ô","‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô","‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î"];
      statusList.forEach(status => header.push(status));
      
      const lines = [header.join(",")];

      rows.forEach(r=>{
        const row = [
          `"${sVal} ‡∏ñ‡∏∂‡∏á ${eVal}"`,
          `"${r.name}"`,
          r.total
        ];
        statusList.forEach(status => row.push(r[status]));
        lines.push(row.join(","));
      });

      const totalRow = ["\"‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î\"","",totalSum.total];
      statusList.forEach(status => totalRow.push(totalSum[status]));
      lines.push(totalRow.join(","));

      // ‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á
      lines.push("");
      lines.push(`‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡∏ô‡∏±‡∏ö‡∏ï‡∏≤‡∏°‡∏à‡∏≥‡∏ô‡∏ß‡∏ô event),${totalEventsCount}`);
      lines.push("");

      lines.push("üìà ‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î");
      lines.push(`‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏î‡∏∑‡∏≠‡∏ô,"${sVal} ‡∏ñ‡∏∂‡∏á ${eVal}"`);
      lines.push(`‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î,${totalSum.total}`);
      statusList.forEach(status => {
        lines.push(`${status},${totalSum[status]}`);
      });

      const csv = "\uFEFF" + lines.join("\n");
      const blob = new Blob([csv], {type:"text/csv;charset=utf-8;"});
      const url = URL.createObjectURL(blob);

      const a = document.createElement("a");
      a.href = url;
      a.download = `‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô-${sVal}_‡∏ñ‡∏∂‡∏á_${eVal}.csv`;
      a.click();

      URL.revokeObjectURL(url);
    });

  </script>
</body>
</html>